<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cat√°logo por Categor√≠as - Modelos 3D</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <header>
    <h1>ICARO 3D</h1>
    <p class="subtitle">Explora nuestra colecci√≥n de modelos 3D</p>
    <div class="user-info">
      <span id="user-name">Usuario</span>
      <button onclick="verPedidos()" class="btn-ver-pedidos">üìã Ver Pedidos</button>
      <button id="admin-panel-btn" class="btn-admin-panel" onclick="irAPanelAdmin()" style="display: none;">Panel Admin</button>
      <button class="btn-logout" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
  </header>

  <main>
    <div class="categorias-container">
      <!-- Las categor√≠as se cargar√°n din√°micamente aqu√≠ -->
      <div id="categorias-grid" class="categorias-grid">
        <!-- Las categor√≠as se cargar√°n aqu√≠ -->
      </div>
    </div>
  </main>

  <footer>
    &copy; 2025 ICARO 3D. Todos los derechos reservados.
  </footer>

  <script src="script.js"></script>
  <script>
    // Verificar si el usuario es administrador
    function verificarAdmin() {
      const usuarioGuardado = localStorage.getItem('usuario');
      if (usuarioGuardado) {
        try {
          const usuario = JSON.parse(usuarioGuardado);
          if (usuario.rol === 'admin') {
            document.getElementById('admin-panel-btn').style.display = 'inline-block';
          }
        } catch (error) {
          console.error('Error al verificar rol:', error);
        }
      }
    }

    // Funci√≥n para ir al panel de administrador
    function irAPanelAdmin() {
      window.location.href = 'admin-panel.html';
    }

    // Funci√≥n para cargar y mostrar categor√≠as
    async function cargarCategorias() {
      try {
        const response = await fetch('Data/productos.json');
        const data = await response.json();
        
        // Agrupar productos por categor√≠a
        const categorias = {};
        data.productos.forEach(producto => {
          if (!categorias[producto.categoria]) {
            categorias[producto.categoria] = [];
          }
          categorias[producto.categoria].push(producto);
        });
        
        const contenedor = document.getElementById('categorias-grid');
        
        // Crear tarjetas de categor√≠a
        Object.keys(categorias).forEach(categoria => {
          const categoriaElement = crearElementoCategoria(categoria, categorias[categoria]);
          contenedor.appendChild(categoriaElement);
        });
        
      } catch (error) {
        console.error('Error al cargar categor√≠as:', error);
      }
    }

    // Funci√≥n para crear el elemento HTML de cada categor√≠a
    function crearElementoCategoria(nombreCategoria, productos) {
      const categoriaDiv = document.createElement('div');
      categoriaDiv.className = 'categoria-card';
      
      // Obtener la imagen del primer producto de la categor√≠a como representativa
      const imagenRepresentativa = productos[0].imagen;
      
      categoriaDiv.innerHTML = `
        <div class="categoria-imagen">
          <img src="${imagenRepresentativa}" alt="${nombreCategoria}" />
          <div class="categoria-overlay">
            <h2>${nombreCategoria}</h2>
            <p>${productos.length} modelo${productos.length > 1 ? 's' : ''} disponible${productos.length > 1 ? 's' : ''}</p>
          </div>
        </div>
        <div class="categoria-info">
          <h3>${nombreCategoria}</h3>
          <p class="categoria-descripcion">Explora nuestra colecci√≥n de modelos ${nombreCategoria.toLowerCase()}</p>
          <div class="productos-preview">
            ${productos.slice(0, 3).map(producto => `
              <div class="producto-mini">
                <img src="${producto.imagen}" alt="${producto.nombre}" />
                <span>${producto.nombre}</span>
              </div>
            `).join('')}
            ${productos.length > 3 ? `<div class="mas-productos">+${productos.length - 3} m√°s</div>` : ''}
          </div>
          <button class="ver-categoria-btn" onclick="mostrarProductosCategoria('${nombreCategoria}')">
            Ver ${nombreCategoria}
          </button>
        </div>
      `;
      
      return categoriaDiv;
    }

    // Funci√≥n para mostrar productos de una categor√≠a espec√≠fica
    function mostrarProductosCategoria(categoria) {
      // Ocultar categor√≠as y mostrar productos
      document.querySelector('.categorias-container').style.display = 'none';
      
      // Crear vista de productos de la categor√≠a
      const main = document.querySelector('main');
      main.innerHTML = `
        <div class="categoria-productos-container">
          <div class="categoria-header">
            <button class="btn-volver-categorias" onclick="volverACategorias()">
              ‚Üê Volver a Categor√≠as
            </button>
            <h2>${categoria}</h2>
          </div>
          <div id="productos-categoria" class="productos-grid">
            <!-- Los productos se cargar√°n aqu√≠ -->
          </div>
        </div>
      `;
      
      // Cargar productos de la categor√≠a
      cargarProductosCategoria(categoria);
    }

    // Funci√≥n para cargar productos de una categor√≠a espec√≠fica
    async function cargarProductosCategoria(categoria) {
      try {
        const response = await fetch('Data/productos.json');
        const data = await response.json();
        
        const productosCategoria = data.productos.filter(p => p.categoria === categoria);
        const contenedor = document.getElementById('productos-categoria');
        
        productosCategoria.forEach(producto => {
          const productoElement = crearElementoProducto(producto);
          contenedor.appendChild(productoElement);
        });
        
      } catch (error) {
        console.error('Error al cargar productos de categor√≠a:', error);
      }
    }

    // Funci√≥n para volver a la vista de categor√≠as
    function volverACategorias() {
      window.location.reload();
    }

    // Cargar categor√≠as cuando la p√°gina est√© lista
    document.addEventListener('DOMContentLoaded', function() {
      cargarCategorias();
      verificarAdmin();
    });

    // Verificar sesi√≥n de usuario
    function verificarSesion() {
      const usuarioGuardado = localStorage.getItem('usuario') || sessionStorage.getItem('usuario');
      
      if (!usuarioGuardado) {
        // Si no hay sesi√≥n, redirigir al login
        window.location.href = 'index.html';
        return;
      }
      
      try {
        const usuario = JSON.parse(usuarioGuardado);
        document.getElementById('user-name').textContent = `${usuario.nombre} ${usuario.apellido}`;
      } catch (error) {
        console.error('Error al cargar sesi√≥n:', error);
        window.location.href = 'index.html';
      }
    }

    // Funci√≥n para cerrar sesi√≥n
    function cerrarSesion() {
      localStorage.removeItem('usuario');
      sessionStorage.removeItem('usuario');
      window.location.href = 'index.html';
    }

    // Verificar sesi√≥n al cargar la p√°gina
    verificarSesion();

    // Funciones de pedidos
    function verPedidos() {
      const pedidos = JSON.parse(localStorage.getItem('pedidos') || '[]');
      
      if (pedidos.length === 0) {
        alert('No hay pedidos agregados');
        return;
      }
      
      // Crear modal para mostrar pedidos
      const modal = document.createElement('div');
      modal.className = 'modal-pedidos';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2>üìã Mis Pedidos</h2>
            <button onclick="cerrarModal()" class="btn-cerrar">√ó</button>
          </div>
          <div class="pedidos-container">
            ${pedidos.map((pedido, index) => `
              <div class="pedido-item">
                <div class="pedido-imagen">
                  <img src="${pedido.imagen}" alt="${pedido.nombre}" />
                </div>
                <div class="pedido-info">
                  <h3>${pedido.nombre}</h3>
                  <p>${pedido.precio}</p>
                  <p>Cantidad: ${pedido.cantidad}</p>
                </div>
                <div class="pedido-checkbox">
                  <label>
                    <input type="checkbox" ${pedido.agregado ? 'checked' : ''} 
                           onchange="toggleAgregado(${index})">
                    <span>${pedido.agregado ? 'Agregado' : 'No agregado'}</span>
                  </label>
                </div>
              </div>
            `).join('')}
          </div>
          <div class="modal-footer">
            <button onclick="realizarPedidoCompleto()" class="btn-realizar-pedido">
              üõí Realizar Pedido Completo
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function cerrarModal() {
      const modal = document.querySelector('.modal-pedidos');
      if (modal) {
        modal.remove();
      }
    }

    function toggleAgregado(index) {
      const pedidos = JSON.parse(localStorage.getItem('pedidos') || '[]');
      pedidos[index].agregado = !pedidos[index].agregado;
      localStorage.setItem('pedidos', JSON.stringify(pedidos));
      
      // Actualizar el texto del checkbox
      const checkbox = event.target;
      const span = checkbox.nextElementSibling;
      span.textContent = checkbox.checked ? 'Agregado' : 'No agregado';
    }

    function realizarPedidoCompleto() {
      const pedidos = JSON.parse(localStorage.getItem('pedidos') || '[]');
      const pedidosAgregados = pedidos.filter(pedido => pedido.agregado);
      
      if (pedidosAgregados.length === 0) {
        alert('No hay pedidos seleccionados para enviar');
        return;
      }
      
      // Obtener informaci√≥n del usuario actual
      const usuarioActual = JSON.parse(localStorage.getItem('usuario') || '{}');
      const nombreUsuario = usuarioActual.nombre || 'Usuario';
      const telefonoUsuario = usuarioActual.telefono || 'No especificado';
      
      const ids = pedidosAgregados.map(pedido => pedido.id).join(', ');
      const productos = pedidosAgregados.map(pedido => pedido.nombre).join(', ');
      const mensaje = `üõí PEDIDO COMPLETO\n\nüë§ Cliente: ${nombreUsuario}\nüì± Tel√©fono: ${telefonoUsuario}\nüì¶ Productos: ${productos}\nüÜî IDs: ${ids}`;
      const token = "8260563638:AAHl4TItRl3FpG_1wkX7YRGWOzmqwuJNdG8";
      const chatId = "5239956110";
      
      // URL de la API de Telegram para enviar mensaje
      const url = `https://api.telegram.org/bot${token}/sendMessage`;
      
      // Datos del mensaje
      const data = {
        chat_id: chatId,
        text: mensaje,
        parse_mode: "HTML"
      };
      
      // Enviar mensaje usando fetch
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.ok) {
          alert('Pedido completo enviado exitosamente a Icaro 3D');
          // Limpiar pedidos despu√©s de enviar
          localStorage.removeItem('pedidos');
          cerrarModal();
        } else {
          alert('Error al enviar pedido: ' + data.description);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar pedido a Icaro 3D');
      });
    }
  </script>

</body>
</html> 