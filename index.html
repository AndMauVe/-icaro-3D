<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ICARO 3D - Iniciar Sesión</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <div class="login-container">
    <div class="login-card">
      <div class="login-header">
        <h1>Mi Tienda</h1>
        <p>Catálogo de Modelos 3D</p>
      </div>

      <!-- Formulario de Login -->
      <div id="login-form" class="form-container">
        <h2>Iniciar Sesión</h2>
        <form id="loginForm" onsubmit="iniciarSesion(event)">
          <div class="form-group">
            <label for="email">Correo Electrónico</label>
            <input type="email" id="email" name="email" required placeholder="tu@email.com">
          </div>
          
          <div class="form-group">
            <label for="password">Contraseña</label>
            <input type="password" id="password" name="password" required placeholder="Tu contraseña">
          </div>
          
          <div class="form-options">
            <label class="checkbox-container">
              <input type="checkbox" id="remember">
              <span class="checkmark"></span>
              Recordarme
            </label>
            <a href="#" class="forgot-password">¿Olvidaste tu contraseña?</a>
          </div>
          
          <button type="submit" class="btn-login">
            <span class="btn-text">Iniciar Sesión</span>
            <span class="btn-loading" style="display: none;">Cargando...</span>
          </button>
        </form>
        
        <div class="divider">
          <span>o</span>
        </div>
        
        <button class="btn-register-toggle" onclick="mostrarRegistro()">
          Crear Nueva Cuenta
        </button>
      </div>

      <!-- Formulario de Registro -->
      <div id="register-form" class="form-container" style="display: none;">
        <h2>Crear Cuenta</h2>
        <form id="registerForm" onsubmit="registrarUsuario(event)">
          <div class="form-row">
            <div class="form-group">
              <label for="nombre">Nombre</label>
              <input type="text" id="nombre" name="nombre" required placeholder="Tu nombre">
            </div>
            
            <div class="form-group">
              <label for="apellido">Apellido</label>
              <input type="text" id="apellido" name="apellido" required placeholder="Tu apellido">
            </div>
          </div>
          
          <div class="form-group">
            <label for="email-register">Correo Electrónico</label>
            <input type="email" id="email-register" name="email" required placeholder="tu@email.com">
          </div>
          
          <div class="form-group">
            <label for="password-register">Contraseña</label>
            <input type="password" id="password-register" name="password" required placeholder="Mínimo 6 caracteres">
          </div>
          
          <div class="form-group">
            <label for="confirm-password">Confirmar Contraseña</label>
            <input type="password" id="confirm-password" name="confirm-password" required placeholder="Repite tu contraseña">
          </div>
          
          <div class="form-options">
            <label class="checkbox-container">
              <input type="checkbox" id="terms" required>
              <span class="checkmark"></span>
              Acepto los <a href="#" class="terms-link">términos y condiciones</a>
            </label>
          </div>
          
          <button type="submit" class="btn-register">
            <span class="btn-text">Crear Cuenta</span>
            <span class="btn-loading" style="display: none;">Creando...</span>
          </button>
        </form>
        
        <div class="divider">
          <span>o</span>
        </div>
        
        <button class="btn-login-toggle" onclick="mostrarLogin()">
          Ya tengo una cuenta
        </button>
      </div>
    </div>

    <!-- Mensajes de error/éxito -->
    <div id="message-container" class="message-container" style="display: none;">
      <div class="message-content">
        <span id="message-text"></span>
        <button class="message-close" onclick="ocultarMensaje()">×</button>
      </div>
    </div>
  </div>

  <script>
    // Variables globales
    let usuarios = [];
    let usuarioActual = null;

    // Cargar usuarios al iniciar
    document.addEventListener('DOMContentLoaded', cargarUsuarios);

    // Función para cargar usuarios desde JSON
    async function cargarUsuarios() {
      try {
        const response = await fetch('Data/usuarios.json');
        const data = await response.json();
        usuarios = data.usuarios;
        console.log('Usuarios cargados:', usuarios.length);
      } catch (error) {
        console.error('Error al cargar usuarios:', error);
        mostrarMensaje('Error al cargar usuarios', 'error');
      }
    }

    // Función para mostrar formulario de registro
    function mostrarRegistro() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'block';
    }

    // Función para mostrar formulario de login
    function mostrarLogin() {
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('login-form').style.display = 'block';
    }

    // Función para iniciar sesión
    async function iniciarSesion(event) {
      event.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const remember = document.getElementById('remember').checked;
      
      // Mostrar loading
      const btn = event.target.querySelector('.btn-login');
      btn.querySelector('.btn-text').style.display = 'none';
      btn.querySelector('.btn-loading').style.display = 'inline';
      btn.disabled = true;
      
      try {
        // Simular delay de red
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Buscar usuario
        const usuario = usuarios.find(u => u.email === email && u.password === password && u.activo);
        
        if (usuario) {
          // Guardar sesión
          usuarioActual = {
            id: usuario.id,
            email: usuario.email,
            nombre: usuario.nombre,
            apellido: usuario.apellido,
            rol: usuario.rol
          };
          
          if (remember) {
            localStorage.setItem('usuario', JSON.stringify(usuarioActual));
          } else {
            sessionStorage.setItem('usuario', JSON.stringify(usuarioActual));
          }
          
          mostrarMensaje(`¡Bienvenido, ${usuario.nombre}!`, 'success');
          
          // Redirigir al catálogo
          setTimeout(() => {
            window.location.href = 'vista_previa.html';
          }, 1500);
          
        } else {
          mostrarMensaje('Correo o contraseña incorrectos', 'error');
        }
        
      } catch (error) {
        console.error('Error al iniciar sesión:', error);
        mostrarMensaje('Error al iniciar sesión', 'error');
      } finally {
        // Restaurar botón
        btn.querySelector('.btn-text').style.display = 'inline';
        btn.querySelector('.btn-loading').style.display = 'none';
        btn.disabled = false;
      }
    }

    // Función para registrar usuario
    async function registrarUsuario(event) {
      event.preventDefault();
      
      const nombre = document.getElementById('nombre').value;
      const apellido = document.getElementById('apellido').value;
      const email = document.getElementById('email-register').value;
      const password = document.getElementById('password-register').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const terms = document.getElementById('terms').checked;
      
      // Validaciones
      if (password.length < 6) {
        mostrarMensaje('La contraseña debe tener al menos 6 caracteres', 'error');
        return;
      }
      
      if (password !== confirmPassword) {
        mostrarMensaje('Las contraseñas no coinciden', 'error');
        return;
      }
      
      if (!terms) {
        mostrarMensaje('Debes aceptar los términos y condiciones', 'error');
        return;
      }
      
      // Verificar si el email ya existe
      const emailExiste = usuarios.find(u => u.email === email);
      if (emailExiste) {
        mostrarMensaje('Este correo electrónico ya está registrado', 'error');
        return;
      }
      
      // Mostrar loading
      const btn = event.target.querySelector('.btn-register');
      btn.querySelector('.btn-text').style.display = 'none';
      btn.querySelector('.btn-loading').style.display = 'inline';
      btn.disabled = true;
      
      try {
        // Simular delay de red
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Crear nuevo usuario
        const nuevoUsuario = {
          id: usuarios.length + 1,
          email: email,
          password: password,
          nombre: nombre,
          apellido: apellido,
          rol: 'usuario',
          fecha_registro: new Date().toISOString().split('T')[0],
          activo: true
        };
        
        // Agregar a la lista (en un sistema real, esto se guardaría en el servidor)
        usuarios.push(nuevoUsuario);
        
        mostrarMensaje('¡Cuenta creada exitosamente!', 'success');
        
        // Cambiar a formulario de login
        setTimeout(() => {
          mostrarLogin();
          // Limpiar formulario de registro
          document.getElementById('registerForm').reset();
        }, 1500);
        
      } catch (error) {
        console.error('Error al registrar usuario:', error);
        mostrarMensaje('Error al crear la cuenta', 'error');
      } finally {
        // Restaurar botón
        btn.querySelector('.btn-text').style.display = 'inline';
        btn.querySelector('.btn-loading').style.display = 'none';
        btn.disabled = false;
      }
    }

    // Función para mostrar mensajes
    function mostrarMensaje(texto, tipo) {
      const container = document.getElementById('message-container');
      const textElement = document.getElementById('message-text');
      
      textElement.textContent = texto;
      container.className = `message-container message-${tipo}`;
      container.style.display = 'block';
      
      // Auto-ocultar después de 5 segundos
      setTimeout(() => {
        ocultarMensaje();
      }, 5000);
    }

    // Función para ocultar mensajes
    function ocultarMensaje() {
      document.getElementById('message-container').style.display = 'none';
    }

    // Verificar si ya hay una sesión activa
    function verificarSesion() {
      const usuarioGuardado = localStorage.getItem('usuario') || sessionStorage.getItem('usuario');
      
      if (usuarioGuardado) {
        try {
          usuarioActual = JSON.parse(usuarioGuardado);
          console.log('Sesión encontrada:', usuarioActual.nombre);
          
          // Redirigir automáticamente si ya está logueado
          if (window.location.pathname.includes('index.html')) {
            window.location.href = 'vista_previa.html';
          }
        } catch (error) {
          console.error('Error al cargar sesión:', error);
        }
      }
    }

    // Ejecutar verificación de sesión
    verificarSesion();
  </script>

</body>
</html> 